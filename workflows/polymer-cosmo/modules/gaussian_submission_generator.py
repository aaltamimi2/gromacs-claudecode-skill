#!/usr/bin/env python3
"""
Gaussian submission script generator for COSMO-RS calculations

Generates a simple sequential SLURM script that runs all Gaussian DFT
calculations one after another.

Usage:
    python gaussian_submission_generator.py conformers/

Example:
    # Generate submission script for all conformers
    python gaussian_submission_generator.py conformers/ --walltime 1080:00:00

    # Custom settings
    python gaussian_submission_generator.py conformers/ --ncores 28 --walltime 720:00:00
"""

import argparse
import sys
from pathlib import Path


def generate_sequential_script(conformer_dir, output_file="submit_gaussian.sh",
                               ncores=28, walltime="1080:00:00",
                               partition="compute",
                               email="aaltamimi2@wisc.edu"):
    """
    Generate simple sequential SLURM script for Gaussian calculations.

    Parameters:
    -----------
    conformer_dir : Path
        Directory containing .gjf files
    output_file : str
        Output script filename
    ncores : int
        Number of CPU cores (default: 28, matches swarm format)
    walltime : str
        Maximum runtime (HH:MM:SS, default: 1080:00:00 = 45 days)
    partition : str
        SLURM partition name
    email : str
        Email for notifications

    Returns:
    --------
    script_path : Path
        Path to generated script
    n_jobs : int
        Number of .gjf files found
    """

    conformer_dir = Path(conformer_dir)
    gjf_files = sorted(conformer_dir.glob("*.gjf"))

    if len(gjf_files) == 0:
        print(f"ERROR: No .gjf files found in {conformer_dir}")
        sys.exit(1)

    n_jobs = len(gjf_files)
    script_path = conformer_dir / output_file

    # Generate SLURM script (matches user's format exactly)
    script_content = f"""#!/bin/bash

#SBATCH -p {partition}
#SBATCH -t {walltime}
#SBATCH -J DFT
#SBATCH --nodes=1
#SBATCH --ntasks-per-node={ncores}
#SBATCH --mail-user={email}
#SBATCH --mail-type=end

# Gaussian COSMO-RS Sequential Job
# Generated by polymer-cosmo workflow
# Runs {n_jobs} conformers sequentially

echo "=========================================="
echo "Gaussian COSMO-RS Batch Calculation"
echo "=========================================="
echo "Job ID:      $SLURM_JOB_ID"
echo "Node:        $(hostname)"
echo "Start time:  $(date)"
echo "Conformers:  {n_jobs}"
echo "=========================================="
echo ""

# Load Gaussian module (adjust module name as needed)
# module load gaussian/g16

# Check Gaussian is available
if ! command -v g16 &> /dev/null; then
    echo "WARNING: g16 command not found"
    echo "  Make sure Gaussian is loaded or in PATH"
    echo "  Uncomment and adjust the module load line above if needed"
    echo ""
fi

# Run all conformers sequentially
"""

    # Add g16 commands for each .gjf file
    for i, gjf_file in enumerate(gjf_files, 1):
        script_content += f"echo \"[{i}/{n_jobs}] Running {gjf_file.name}...\"\n"
        script_content += f"g16 {gjf_file.name}\n"
        script_content += f"echo \"  Completed: {gjf_file.name}\"\n"
        script_content += f"echo \"\"\n"

    # Add completion message
    script_content += """
echo "=========================================="
echo "All Gaussian calculations completed"
echo "End time: $(date)"
echo "=========================================="

# Check how many completed successfully
echo ""
echo "Checking completion status..."
SUCCESS_COUNT=0
TOTAL_COUNT=0

for logfile in *.log; do
    if [ -f "$logfile" ]; then
        TOTAL_COUNT=$((TOTAL_COUNT + 1))
        if grep -q "Normal termination" "$logfile"; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        else
            echo "  ⚠️  $logfile - may have errors"
        fi
    fi
done

echo ""
echo "Results:"
echo "  Successful: $SUCCESS_COUNT / $TOTAL_COUNT"
echo "  Failed:     $((TOTAL_COUNT - SUCCESS_COUNT)) / $TOTAL_COUNT"

if [ $SUCCESS_COUNT -eq $TOTAL_COUNT ]; then
    echo ""
    echo "✓ All calculations completed successfully!"
    exit 0
else
    echo ""
    echo "⚠️  Some calculations had errors - check log files"
    exit 1
fi
"""

    with open(script_path, 'w') as f:
        f.write(script_content)

    script_path.chmod(0o755)

    return script_path, n_jobs


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description="Generate Gaussian submission script for COSMO-RS",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
---------
# Basic usage (default settings):
python gaussian_submission_generator.py conformers/

# Custom walltime (45 days total):
python gaussian_submission_generator.py conformers/ --walltime 1080:00:00

# Custom cores (if using different node):
python gaussian_submission_generator.py conformers/ --ncores 56

# Full customization:
python gaussian_submission_generator.py conformers/ --ncores 28 --walltime 720:00:00 --email user@wisc.edu

Notes:
------
- Script runs all conformers SEQUENTIALLY (one after another)
- Total walltime should account for all conformers
- Estimate ~24-168 hours per conformer for DFT calculations
- For 27 conformers at ~40 hours each = ~1080 hours total (45 days)
- Uses 28 cores by default (matches swarm compute nodes)
- Edit the generated script to comment out specific conformers if needed

After generation:
-----------------
1. Review the generated submit_gaussian.sh
2. Comment out conformers you want to skip (add # before g16 line)
3. Submit: sbatch submit_gaussian.sh
4. Monitor: squeue -u $USER
        """
    )

    parser.add_argument('conformer_dir',
                       help='Directory containing .gjf files')
    parser.add_argument('--ncores',
                       type=int,
                       default=28,
                       help='Number of CPU cores (default: 28)')
    parser.add_argument('--walltime',
                       default='1080:00:00',
                       help='Walltime HH:MM:SS (default: 1080:00:00 = 45 days)')
    parser.add_argument('--partition',
                       default='compute',
                       help='SLURM partition (default: compute)')
    parser.add_argument('--email',
                       default='aaltamimi2@wisc.edu',
                       help='Email for notifications')
    parser.add_argument('-o', '--output',
                       default='submit_gaussian.sh',
                       help='Output script name (default: submit_gaussian.sh)')

    args = parser.parse_args()

    # Validate
    conformer_dir = Path(args.conformer_dir)
    if not conformer_dir.exists():
        print(f"ERROR: Directory not found: {conformer_dir}")
        sys.exit(1)

    # Check for .gjf files
    gjf_files = list(conformer_dir.glob("*.gjf"))
    if len(gjf_files) == 0:
        print(f"ERROR: No .gjf files found in {conformer_dir}")
        print("  Make sure you've run prepare_gaussian.py first!")
        sys.exit(1)

    print("=" * 70)
    print("GAUSSIAN SUBMISSION SCRIPT GENERATOR")
    print("=" * 70)
    print(f"Conformer directory: {conformer_dir}")
    print(f"Found .gjf files:    {len(gjf_files)}")
    print(f"Cores:               {args.ncores}")
    print(f"Walltime:            {args.walltime}")
    print(f"Partition:           {args.partition}")
    print(f"Mode:                Sequential (runs all conformers one-by-one)")
    print("=" * 70)
    print("")

    try:
        script_path, n_jobs = generate_sequential_script(
            conformer_dir,
            output_file=args.output,
            ncores=args.ncores,
            walltime=args.walltime,
            partition=args.partition,
            email=args.email
        )

        print(f"✓ Generated submission script: {script_path}")
        print(f"✓ Will run {n_jobs} conformers sequentially")
        print("")
        print("=" * 70)
        print("READY TO SUBMIT")
        print("=" * 70)
        print(f"\nTo submit:")
        print(f"  cd {conformer_dir}")
        print(f"  sbatch {args.output}")
        print("")
        print("Monitor progress:")
        print(f"  squeue -u {args.email.split('@')[0]}")
        print(f"  tail -f slurm-*.out")
        print("")
        print("To skip specific conformers:")
        print(f"  Edit {script_path} and comment out unwanted g16 lines with #")
        print("")
        print("=" * 70)

    except Exception as e:
        print(f"\nFATAL ERROR: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()
