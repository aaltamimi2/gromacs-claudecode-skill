#!/usr/bin/env python3
"""
submission_generator.py - Generate SLURM submission scripts for polymer MD

Creates swarm-compatible job scripts for workstation and cluster execution.
"""

from pathlib import Path
from typing import Optional


class SubmissionGenerator:
    """Generate SLURM job submission scripts."""

    def __init__(self, work_dir: Path):
        """
        Initialize submission generator.

        Args:
            work_dir: Working directory containing simulation files
        """
        self.work_dir = Path(work_dir)

    def generate_swarm_script(
        self,
        job_name: str,
        email: str = "aaltamimi2@wisc.edu",
        walltime: str = "72:00:00",
        run_em: bool = True,
        run_nvt: bool = True,
        run_npt: bool = True
    ) -> Path:
        """
        Generate SLURM submission script for swarm cluster.

        Args:
            job_name: Name for the SLURM job
            email: Email for notifications
            walltime: Maximum runtime (HH:MM:SS)
            run_em: Include energy minimization
            run_nvt: Include NVT equilibration (10 ns)
            run_npt: Include NPT equilibration (5 ns)

        Returns:
            Path to generated script
        """
        script_path = self.work_dir / "submit_swarm.sh"

        # Build script content
        script = f"""#!/bin/bash
#SBATCH -p compute
#SBATCH -t {walltime}
#SBATCH -J {job_name}
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=28
#SBATCH --mail-user={email}
#SBATCH --mail-type=end

# Polymer-solvent MD simulation
# Generated by polymer-cosmo workflow

module load gromacs

echo "Starting simulation: {job_name}"
echo "Working directory: $(pwd)"
echo "Date: $(date)"

"""

        # Energy Minimization
        if run_em:
            script += """
# ============================================================
# Energy Minimization
# ============================================================
echo ""
echo "=========================================="
echo "Starting Energy Minimization"
echo "=========================================="

if [ ! -f em.tpr ]; then
    echo "ERROR: em.tpr not found. Run grompp first."
    exit 1
fi

gmx mdrun -nt 28 -v -deffnm em

if [ $? -ne 0 ]; then
    echo "ERROR: Energy minimization failed"
    exit 1
fi

echo "✓ Energy minimization completed"
"""

        # NVT Equilibration
        if run_nvt:
            script += """
# ============================================================
# NVT Equilibration (10 ns)
# ============================================================
echo ""
echo "=========================================="
echo "Starting NVT Equilibration (10 ns)"
echo "=========================================="

# Prepare NVT
gmx grompp -f nvt.mdp -c em.gro -p topol.top -o nvt.tpr -maxwarn 10

if [ $? -ne 0 ]; then
    echo "ERROR: NVT preparation failed"
    exit 1
fi

# Run NVT with GPU acceleration
gmx mdrun -v -deffnm nvt -nb gpu -bonded cpu -update gpu -ntomp 16 -pin on

if [ $? -ne 0 ]; then
    echo "ERROR: NVT equilibration failed"
    exit 1
fi

echo "✓ NVT equilibration completed"

# Quick quality check
echo ""
echo "NVT Quality Check:"
echo "Temperature" | gmx energy -f nvt.edr -o nvt_temp.xvg 2>&1 | grep "Average"
"""

        # NPT Equilibration
        if run_npt:
            script += """
# ============================================================
# NPT Equilibration (5 ns)
# ============================================================
echo ""
echo "=========================================="
echo "Starting NPT Equilibration (5 ns)"
echo "=========================================="

# Prepare NPT
gmx grompp -f npt.mdp -c nvt.gro -t nvt.cpt -p topol.top -o npt.tpr -maxwarn 10

if [ $? -ne 0 ]; then
    echo "ERROR: NPT preparation failed"
    exit 1
fi

# Run NPT with GPU acceleration
gmx mdrun -v -deffnm npt -nb gpu -bonded cpu -update gpu -ntomp 16 -pin on

if [ $? -ne 0 ]; then
    echo "ERROR: NPT equilibration failed"
    exit 1
fi

echo "✓ NPT equilibration completed"

# Quality checks
echo ""
echo "NPT Quality Check:"
echo "Temperature" | gmx energy -f npt.edr -o npt_temp.xvg 2>&1 | grep "Average"
echo "Pressure" | gmx energy -f npt.edr -o npt_press.xvg 2>&1 | grep "Average"
echo "Density" | gmx energy -f npt.edr -o npt_density.xvg 2>&1 | grep "Average"
"""

        # Completion message
        script += """
# ============================================================
# Simulation Complete
# ============================================================
echo ""
echo "=========================================="
echo "✓ All simulations completed successfully"
echo "=========================================="
echo "End time: $(date)"

# List output files
echo ""
echo "Output files:"
ls -lh *.gro *.xtc *.edr *.log 2>/dev/null
"""

        # Write script
        with open(script_path, 'w') as f:
            f.write(script)

        # Make executable
        script_path.chmod(0o755)

        print(f"\n✓ Generated swarm submission script: {script_path}")
        return script_path

    def generate_workstation_script(
        self,
        job_name: str,
        run_em: bool = True,
        run_nvt: bool = True,
        run_npt: bool = True
    ) -> Path:
        """
        Generate bash script for workstation execution (gmx_mpi).

        Args:
            job_name: Name for the job
            run_em: Include energy minimization
            run_nvt: Include NVT equilibration
            run_npt: Include NPT equilibration

        Returns:
            Path to generated script
        """
        script_path = self.work_dir / "run_workstation.sh"

        script = f"""#!/bin/bash
# Workstation MD simulation script
# Generated by polymer-cosmo workflow
# Uses gmx_mpi (not gmx)

echo "Starting simulation: {job_name}"
echo "Working directory: $(pwd)"
echo "Date: $(date)"

"""

        # Energy Minimization
        if run_em:
            script += """
# ============================================================
# Energy Minimization
# ============================================================
echo ""
echo "=========================================="
echo "Starting Energy Minimization"
echo "=========================================="

if [ ! -f em.tpr ]; then
    echo "ERROR: em.tpr not found. Run grompp first."
    exit 1
fi

gmx_mpi mdrun -v -deffnm em

if [ $? -ne 0 ]; then
    echo "ERROR: Energy minimization failed"
    exit 1
fi

echo "✓ Energy minimization completed"
"""

        # NVT
        if run_nvt:
            script += """
# ============================================================
# NVT Equilibration (10 ns)
# ============================================================
echo ""
echo "=========================================="
echo "Starting NVT Equilibration (10 ns)"
echo "=========================================="

gmx_mpi grompp -f nvt.mdp -c em.gro -p topol.top -o nvt.tpr -maxwarn 10

if [ $? -ne 0 ]; then
    echo "ERROR: NVT preparation failed"
    exit 1
fi

gmx_mpi mdrun -v -deffnm nvt

if [ $? -ne 0 ]; then
    echo "ERROR: NVT equilibration failed"
    exit 1
fi

echo "✓ NVT equilibration completed"
"""

        # NPT
        if run_npt:
            script += """
# ============================================================
# NPT Equilibration (5 ns)
# ============================================================
echo ""
echo "=========================================="
echo "Starting NPT Equilibration (5 ns)"
echo "=========================================="

gmx_mpi grompp -f npt.mdp -c nvt.gro -t nvt.cpt -p topol.top -o npt.tpr -maxwarn 10

if [ $? -ne 0 ]; then
    echo "ERROR: NPT preparation failed"
    exit 1
fi

gmx_mpi mdrun -v -deffnm npt

if [ $? -ne 0 ]; then
    echo "ERROR: NPT equilibration failed"
    exit 1
fi

echo "✓ NPT equilibration completed"
"""

        script += """
echo ""
echo "=========================================="
echo "✓ Simulation completed successfully"
echo "=========================================="
echo "End time: $(date)"
"""

        with open(script_path, 'w') as f:
            f.write(script)

        script_path.chmod(0o755)

        print(f"\n✓ Generated workstation script: {script_path}")
        return script_path

    def generate_preparation_script(self) -> Path:
        """
        Generate script to prepare .tpr files before submission.

        Returns:
            Path to preparation script
        """
        script_path = self.work_dir / "prepare_simulations.sh"

        script = """#!/bin/bash
# Prepare .tpr files for simulation
# Run this on workstation before transferring to swarm

echo "Preparing simulation files..."

# Check required files
REQUIRED_FILES="em.mdp nvt.mdp npt.mdp topol.top system_solvated.gro"
for file in $REQUIRED_FILES; do
    if [ ! -f "$file" ]; then
        echo "ERROR: Required file missing: $file"
        exit 1
    fi
done

echo "✓ All required files present"

# Prepare EM
echo ""
echo "Preparing energy minimization..."
gmx_mpi grompp -f em.mdp -c system_solvated.gro -p topol.top -o em.tpr -maxwarn 10

if [ $? -ne 0 ]; then
    echo "ERROR: Failed to prepare EM"
    exit 1
fi

echo "✓ em.tpr created"

echo ""
echo "=========================================="
echo "✓ Preparation complete"
echo "=========================================="
echo ""
echo "Files ready for simulation:"
ls -lh *.tpr *.mdp *.top *.gro 2>/dev/null

echo ""
echo "Next steps:"
echo "  1. Review files above"
echo "  2. Transfer to swarm: scp *.tpr *.mdp *.top *.gro *.itp *.acpype swarm:~/project_dir/"
echo "  3. Submit job: ssh swarm 'cd ~/project_dir && sbatch submit_swarm.sh'"
"""

        with open(script_path, 'w') as f:
            f.write(script)

        script_path.chmod(0o755)

        print(f"\n✓ Generated preparation script: {script_path}")
        return script_path


def main():
    """CLI for submission generator."""
    import argparse

    parser = argparse.ArgumentParser(description="Generate MD submission scripts")
    parser.add_argument("work_dir", help="Working directory")
    parser.add_argument("--job-name", required=True, help="Job name")
    parser.add_argument("--email", default="aaltamimi2@wisc.edu",
                        help="Email for notifications")
    parser.add_argument("--walltime", default="72:00:00",
                        help="Walltime (HH:MM:SS)")
    parser.add_argument("--target", choices=["swarm", "workstation", "both"],
                        default="both", help="Target platform")
    parser.add_argument("--skip-em", action="store_true",
                        help="Skip energy minimization")
    parser.add_argument("--skip-nvt", action="store_true",
                        help="Skip NVT equilibration")
    parser.add_argument("--skip-npt", action="store_true",
                        help="Skip NPT equilibration")

    args = parser.parse_args()

    gen = SubmissionGenerator(args.work_dir)

    if args.target in ["swarm", "both"]:
        gen.generate_swarm_script(
            args.job_name,
            args.email,
            args.walltime,
            not args.skip_em,
            not args.skip_nvt,
            not args.skip_npt
        )

    if args.target in ["workstation", "both"]:
        gen.generate_workstation_script(
            args.job_name,
            not args.skip_em,
            not args.skip_nvt,
            not args.skip_npt
        )

    gen.generate_preparation_script()

    print("\n✓ All scripts generated successfully")


if __name__ == "__main__":
    main()
